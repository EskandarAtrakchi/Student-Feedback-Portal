<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title><%= title %></title>
  </head>
  <body>
    <header>
      <h1>Student Feedback Portal</h1>
      <nav>
        <a href="/">Home</a> |
        <a href="/posts">Posts</a> |
        <a href="/search">Search</a> |
        <% if (currentUser) { %>
          <span>Logged in as <%= currentUser.username %></span> |
          <a href="/logout">Logout</a>
        <% } else { %>
          <a href="/register">Register</a> |
          <a href="/login">Login</a>
        <% } %>
      </nav>
      <hr />
    </header>

    <main>
      <article>
        <!-- INSECURE: raw HTML output for title and content -->
        <h2><%- post.title %></h2>
        <p>by <%= post.author || 'Anonymous' %> (on <%= post.created_at %>)</p>
        <div>
          <%- post.content %>
        </div>
      </article>

      <section>
        <h3>Comments</h3>

        <% if (comments.length === 0) { %>
          <p>No comments yet.</p>
        <% } else { %>
          <ul>
            <% comments.forEach(c => { %>
              <li>
                <!-- INSECURE: comment content not escaped (stored XSS) -->
                <strong><%= c.author_name %>:</strong>
                <span><%- c.content %></span>
                <small> (on <%= c.created_at %>)</small>
              </li>
            <% }); %>
          </ul>
        <% } %>
      </section>

      <section>
        <h3>Add a Comment</h3>
        <form method="post" action="/posts/<%= post.id %>/comments">
          <div>
            <label>Your name:</label>
            <input name="author_name" required />
          </div>
          <div>
            <label>Comment:</label><br />
            <textarea name="content" rows="3" cols="40" required></textarea>
          </div>
          <button type="submit">Submit Comment</button>
        </form>
      </section>

      <section>
        <h3>Status message (DOM-based XSS demo)</h3>
        <div id="status"></div>

        <script>
          // INSECURE: DOM-based XSS using innerHTML
          const params = new URLSearchParams(window.location.search);
          const msg = params.get('msg');
          if (msg) {
            document.getElementById('status').innerHTML = msg;
          }
        </script>
      </section>
    </main>
  </body>
</html>
